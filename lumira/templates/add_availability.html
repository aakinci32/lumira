{% extends "base.html" %}

{% block title %}Add Availability{% endblock %}

{% block content %}<section class="section container">
    <h1 class="section__title">Add Availability</h1>
    <p>Fill in your availability for tutoring sessions below:</p>

    <!-- Time Selection Section -->
    <form id="availability-form" class="form">
        {% csrf_token %}
        <h2>Time Selection</h2>
        <div class="form__group">
            {{ form.date.label_tag }}
            <input
                type="date"
                name="{{ form.date.name }}"
                id="{{ form.date.id_for_label }}"
                min="{{ today }}"
            />
        </div>
        <div class="form__group">
            {{ form.start_time.label_tag }}
            {{ form.start_time }}
        </div>
        <div class="form__group">
            {{ form.end_time.label_tag }}
            {{ form.end_time }}
        </div>
        <button type="button" id="add-time-button" class="button">Add Time Slot</button>
    </form>

    <!-- Selected Times -->
    <h2 id="selected-times-header" style="display: none;">Selected Times:</h2>
    <ul id="selected-times" class="slot-list"></ul>

    <!-- Filter Adjustment Section -->
    <form id="filter-form" class="form">
        {% csrf_token %}
        <h2>Adjust Filters</h2>
        <div class="form__group">
            <label for="exam-type">Exam Type</label>
            <select name="exam_type" id="exam-type">
                <option value="" disabled selected>Select an exam</option>
                <option value="SAT">SAT</option>
                <option value="ACT">ACT</option>
                <option value="LSAT">LSAT</option>
            </select>
        </div>
        <div class="form__group">
            <label for="language">Language</label>
            <select name="language" id="language">
                <option value="" disabled selected>Select a language</option>
                <option value="English">English</option>
                <option value="Spanish">Spanish</option>
                <option value="French">French</option>
            </select>
        </div>
        <button type="button" id="apply-filters-button" class="button">Apply Filters</button>
    </form>

    <!-- Submit Form -->
    <form method="post" id="submit-form" class="form">
        {% csrf_token %}
        <input type="hidden" id="times-input" name="times">
        <input type="hidden" id="filters-input" name="filters">
        <button type="submit" class="button">Save Availability</button>
    </form>
</section>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        const availabilityForm = document.getElementById('availability-form');
        const addTimeButton = document.getElementById('add-time-button');
        const selectedTimesHeader = document.getElementById('selected-times-header');
        const selectedTimesList = document.getElementById('selected-times');
        const timesInput = document.getElementById('times-input');
        let selectedTimes = [];

        addTimeButton.addEventListener('click', function () {
            const date = availabilityForm.querySelector('[name="date"]').value;
            const startTime = availabilityForm.querySelector('[name="start_time"]').value;
            const endTime = availabilityForm.querySelector('[name="end_time"]').value;

            if (date && startTime && endTime) {
                const timeSlot = `${date} ${startTime} - ${endTime}`;
                if (!selectedTimes.includes(timeSlot)) {
                    selectedTimes.push(timeSlot);

                    const slotContainer = document.createElement('div');
                    slotContainer.className = 'slot-item';

                    const slotText = document.createElement('span');
                    slotText.textContent = timeSlot;

                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = '&times;';
                    removeButton.className = 'remove-slot-circle';
                    removeButton.type = 'button';
                    removeButton.addEventListener('click', function () {
                        selectedTimes = selectedTimes.filter(s => s !== timeSlot);
                        slotContainer.remove();
                        updateTimesInput();
                    });

                    slotContainer.appendChild(slotText);
                    slotContainer.appendChild(removeButton);
                    selectedTimesList.appendChild(slotContainer);
                    updateTimesInput();
                }
            } else {
                alert("Please complete all fields for time selection.");
            }
        });

        function updateTimesInput() {
            timesInput.value = JSON.stringify(selectedTimes);
            toggleSelectedTimesHeader();
        }

        function toggleSelectedTimesHeader() {
            if (selectedTimes.length > 0) {
                selectedTimesHeader.style.display = 'block';
            } else {
                selectedTimesHeader.style.display = 'none';
            }
        }
    });




    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.querySelector('input[type="date"]');
        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
        dateInput.setAttribute('min', today); // Set the minimum date
    });

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('availability-form');
        const addSlotButton = document.getElementById('add-slot-button');
        const selectedSlotsList = document.getElementById('selected-slots');
        const slotsInput = document.getElementById('slots-input');
        let selectedSlots = [];

        addSlotButton.addEventListener('click', function () {
            const date = form.querySelector('[name="date"]').value;
            const startTime = form.querySelector('[name="start_time"]').value;
            const endTime = form.querySelector('[name="end_time"]').value;

            if (date && startTime && endTime) {
                const slot = `${date} ${startTime} - ${endTime}`;
                if (!selectedSlots.includes(slot)) {
                    selectedSlots.push(slot);

                    // Create a new slot container
                    const slotContainer = document.createElement('div');
                    slotContainer.className = 'slot-item';

                    // Add the slot text
                    const slotText = document.createElement('span');
                    slotText.textContent = slot;

                    // Add the circular "X" button
                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = '&times;';
                    removeButton.className = 'remove-slot-circle';
                    removeButton.type = 'button';
                    removeButton.addEventListener('click', function () {
                        selectedSlots = selectedSlots.filter(s => s !== slot);
                        slotContainer.remove();
                        updateHiddenInput();
                    });

                    // Append elements
                    slotContainer.appendChild(slotText);
                    slotContainer.appendChild(removeButton);
                    selectedSlotsList.appendChild(slotContainer);
                    updateHiddenInput();
                }
            }
        });


        function updateHiddenInput() {
            slotsInput.value = JSON.stringify(selectedSlots);
        }
    });
</script>
{% endblock %}
